{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ portal_title|default:"PISOWifi Portal" }}</title>
    {% if favicon %}<link rel="icon" type="image/x-icon" href="{{ favicon }}">{% endif %}
    <!-- Use offline Bootstrap and FontAwesome -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/fontawesome.min.css' %}">
    <style>
        body {
            background: linear-gradient(135deg, {{ primary_color|default:"#007bff" }} 0%, {{ secondary_color|default:"#0056b3" }} 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: {{ text_color|default:"#212529" }};
        }
        .content-wrapper {
            background: {{ background_color|default:"white" }};
            min-height: 100vh;
            width: 100%;
        }
        .portal-header {
            text-align: center;
            margin-bottom: 0;
        }
        .portal-header h1 {
            color: #333;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .portal-header p {
            color: #666;
            font-size: 1.1rem;
        }
        .status-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0;
            padding: 30px 20px;
            margin: 0 20px 20px 20px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .status-item:last-child {
            margin-bottom: 0;
        }
        .status-label {
            font-weight: 500;
            color: #495057;
        }
        .status-value {
            font-weight: 600;
            color: {{ primary_color|default:"#007bff" }};
        }
        .btn-portal {
            width: calc(100% - 40px);
            margin: 0 20px 10px 20px;
            padding: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
        }
        .wifi-icon {
            font-size: 3rem;
            color: {{ primary_color|default:"#007bff" }};
            margin-bottom: 20px;
        }
        .blocked-message {
            background: #dc3545;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        .blocked-message h4 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="content-wrapper">
        <div class="portal-header">
            <div class="banner-carousel" style="position: relative; width: 100%; height: 250px; margin-bottom: 0; overflow: hidden;">
                {% if logo %}
                <!-- Portal Logo -->
                <div style="position: absolute; top: 10px; left: 10px; z-index: 10;">
                    <img src="{{ logo }}" alt="Portal Logo" style="max-height: 50px; max-width: 150px; object-fit: contain;">
                </div>
                {% endif %}
                
                {% for image in banner_images %}
                <div class="carousel-slide {% if forloop.first %}active{% endif %}" 
                     style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: {% if forloop.first %}1{% else %}0{% endif %}; transition: opacity 1s ease-in-out;"
                     {% if image.link_url %}onclick="window.open('{{ image.link_url }}', '{% if image.open_in_new_tab %}_blank{% else %}_self{% endif %}')" style="cursor: pointer;"{% endif %}>
                    <img src="{{ image.url }}" alt="{{ image.alt_text }}" style="width: 100%; height: 100%; object-fit: cover;" />
                </div>
                {% endfor %}
                
                <!-- Portal Title Overlay -->
                {% if portal_title or portal_subtitle %}
                <div style="position: absolute; bottom: 20px; left: 20px; right: 20px; z-index: 10; text-align: center;">
                    {% if portal_title %}<h1 style="color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); margin: 0; font-size: 1.8rem;">{{ portal_title }}</h1>{% endif %}
                    {% if portal_subtitle %}<p style="color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); margin: 5px 0 0 0; font-size: 1.1rem;">{{ portal_subtitle }}</p>{% endif %}
                </div>
                {% endif %}
                
                <!-- Carousel indicators (only show if more than 1 image) -->
                {% if banner_images|length > 1 %}
                <div class="carousel-indicators" style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px;">
                    {% for image in banner_images %}
                    <div class="indicator {% if forloop.first %}active{% endif %}" style="width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,{% if forloop.first %}0.8{% else %}0.4{% endif %}); cursor: pointer; transition: background 0.3s;"></div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Maintenance Mode Check -->
        {% if maintenance_mode %}
        <div class="blocked-message">
            <h4><i class="fas fa-tools me-2"></i>Maintenance Mode</h4>
            <p>{{ maintenance_message|default:"The portal is currently under maintenance. Please try again later." }}</p>
        </div>
        {% elif status == 'Blocked' %}
        <div class="blocked-message">
            <h4><i class="fas fa-ban me-2"></i>Device Blocked</h4>
            <p>Your device has been blocked from accessing the network.</p>
            <p><strong>Reason:</strong> {{ block_reason }}</p>
            {% if blocked_until %}
            <p><strong>Blocked until:</strong> {{ blocked_until }}</p>
            {% endif %}
        </div>
        {% else %}
        
        <div class="status-card text-center">
            <div class="mb-4">
                <div style="font-size: 2.5rem; font-weight: bold;">
                    {% if status == 'Connected' %}
                        <span style="color: #28a745;"><i class="fas fa-check-circle me-2"></i>Connected</span>
                    {% elif status == 'Paused' %}
                        <span style="color: #ffc107;"><i class="fas fa-pause-circle me-2"></i>Paused</span>
                    {% else %}
                        <span style="color: #dc3545;"><i class="fas fa-times-circle me-2"></i>Disconnected</span>
                    {% endif %}
                </div>
            </div>
            
            <!-- System Status Information -->
            <div class="mb-0">
                <!-- Internet Status -->
                <div class="d-flex justify-content-center align-items-center gap-2">
                    <div class="status-label" style="font-size: 0.85rem;">
                        <i class="fas fa-globe me-1"></i>Internet
                    </div>
                    <div>
                        {% if internet_connected %}
                            <span class="badge bg-success" style="font-size: 0.75rem;"><i class="fas fa-check-circle me-1"></i>{{ internet_connected|yesno:"Online,Offline" }}</span>
                        {% else %}
                            <span class="badge bg-danger" style="font-size: 0.75rem;"><i class="fas fa-times-circle me-1"></i>Offline</span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- AutoPause Status -->
                <div class="d-flex justify-content-center align-items-center gap-2">
                    <div class="status-label" style="font-size: 0.85rem;">
                        <i class="fas fa-pause me-1"></i>AutoPause
                    </div>
                    <div>
                        {% if pause_resume_flg == 1 %}
                            <span class="badge bg-info" style="font-size: 0.75rem;"><i class="fas fa-check-circle me-1"></i>Enabled</span>
                        {% else %}
                            <span class="badge bg-secondary" style="font-size: 0.75rem;"><i class="fas fa-times-circle me-1"></i>Disabled</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Client MAC and IP Address Section -->
            <div class="text-center {% if validity_expires_on %}mb-0{% else %}mb-3{% endif %}">
                <span class="mac-address-info" 
                      style="font-size: 0.9rem; font-family: 'Courier New', monospace; cursor: pointer; color: #6c757d;" 
                      onclick="copyMacAddress()" 
                      title="Click to copy"
                      id="macAddress">
                    MAC:{{ mac|upper }} || IP:<span id="compressedIP">{{ ip|default:"Unknown" }}</span>
                </span>
            </div>
            
            <!-- Validity Expiration Section -->
            {% if validity_expires_on %}
            <div class="text-center mb-3">
                <span class="mac-address-info" 
                      style="font-size: 0.9rem; font-family: 'Courier New', monospace; cursor: pointer; {% if validity_color == 'red' %}color: #dc3545;{% elif validity_color == 'orange' %}color: #fd7e14;{% else %}color: #6c757d;{% endif %}" 
                      onclick="copyExpiryDate()" 
                      title="Click to copy"
                      id="expiryDate">
                    EXPIRATION:{{ validity_expires_on|date:"n/j/y G:i a" }}
                </span>
            </div>
            {% endif %}
            
            {% if time_left > 0 and show_timer %}
            <div class="mb-4">
                <div class="status-label">
                    <i class="fas fa-clock me-2"></i>REMAINING TIME
                </div>
                <div style="font-size: 1.8rem; font-weight: bold; color: #007bff;">
                    <span id="timeLeft" data-seconds="{{ time_left }}">{{ time_left }}</span>
                </div>
            </div>
            {% endif %}
            
            <!-- Credit Status Section -->
            <div class="mb-4" id="creditSection" style="display: none;">
                <div class="status-label">
                    <i class="fas fa-coins me-2"></i>Available Credits
                </div>
                <div class="credit-info bg-light p-3 rounded">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;">
                                    <span id="creditAmount">₱0.00</span>
                                </div>
                                <small class="text-muted">Credit Value</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #007bff;">
                                    <span id="creditTime">0 min</span>
                                </div>
                                <small class="text-muted">Available Time</small>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-success">
                            <i class="fas fa-info-circle me-1"></i>
                            Credits are automatically used when you connect
                        </small>
                    </div>
                </div>
            </div>
            
            {% if whitelisted %}
            <div class="mb-3">
                <div class="status-label mb-1" style="font-size: 0.85rem;">
                    <i class="fas fa-check-circle me-1"></i>Access Level
                </div>
                <div>
                    <span class="badge bg-success" style="font-size: 0.75rem;">Whitelisted</span>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="d-grid gap-2">
            {% if not whitelisted %}
                {% if not internet_connected %}
                    <!-- Show disabled state when no internet -->
                    <div class="alert alert-warning text-center mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>No Internet Connection</strong><br>
                        <small>Services are temporarily unavailable</small>
                    </div>
                    <button class="btn btn-secondary btn-portal" disabled>
                        <i class="fas fa-coins me-2"></i>INSERT COIN (Offline)
                    </button>
                    {% if enable_vouchers %}
                    <button class="btn btn-secondary btn-portal" disabled>
                        <i class="fas fa-ticket-alt me-2"></i>Use Voucher (Offline)
                    </button>
                    {% endif %}
                {% else %}
                    {% if status == 'Paused' %}
                    {% if enable_pause_resume %}
                    <button class="btn btn-success btn-portal" onclick="resumeSession()">
                        <i class="fas fa-play me-2"></i>Resume Session
                    </button>
                    {% endif %}
                    <button class="btn btn-primary btn-portal" onclick="insertCoin()">
                        <i class="fas fa-coins me-2"></i>INSERT COIN
                    </button>
                    {% elif status == 'Connected' %}
                    {% if enable_pause_resume %}
                    <button class="btn btn-warning btn-portal" onclick="pauseSession()">
                        <i class="fas fa-pause me-2"></i>Pause Session
                    </button>
                    {% endif %}
                    <button class="btn btn-primary btn-portal" onclick="insertCoin()">
                        <i class="fas fa-coins me-2"></i>EXTEND
                    </button>
                    {% else %}
                    <button class="btn btn-primary btn-portal" onclick="insertCoin()">
                        <i class="fas fa-coins me-2"></i>INSERT COIN
                    </button>
                    {% if enable_vouchers %}
                    <button class="btn btn-success btn-portal" onclick="useVoucher()">
                        <i class="fas fa-ticket-alt me-2"></i>Use Voucher
                    </button>
                    {% endif %}
                    {% endif %}
                {% endif %}
            {% endif %}
            
            <!-- WiFi Rates Button -->
            <button class="btn btn-outline-info btn-sm mt-2" onclick="showRates()" style="font-size: 0.85rem;">
                <i class="fas fa-list me-2"></i>View WiFi Rates
            </button>
        </div>
        {% endif %}

        <!-- Portal Text Content -->
        {% if portal_texts.welcome_message %}
        <div class="text-center mt-3 p-3 bg-light rounded">
            <div style="{% if portal_texts.welcome_message.font_size %}font-size: {{ portal_texts.welcome_message.font_size }};{% endif %} 
                        {% if portal_texts.welcome_message.font_weight %}font-weight: {{ portal_texts.welcome_message.font_weight }};{% endif %}
                        {% if portal_texts.welcome_message.text_align %}text-align: {{ portal_texts.welcome_message.text_align }};{% endif %}">
                {{ portal_texts.welcome_message.content|safe }}
            </div>
        </div>
        {% endif %}
        
        {% if portal_texts.contact_info %}
        <div class="text-center mt-3">
            <small class="text-muted" style="{% if portal_texts.contact_info.font_size %}font-size: {{ portal_texts.contact_info.font_size }};{% endif %}">
                <i class="fas fa-info-circle me-1"></i>
                {{ portal_texts.contact_info.content|safe }}
            </small>
        </div>
        {% else %}
        <div class="text-center mt-3">
            <small class="text-muted">
                <i class="fas fa-shield-alt me-1"></i>
                Secure Connection Protected
            </small>
        </div>
        {% endif %}
    </div>

    <!-- Audio Elements for Portal Sounds -->
    {% if portal_audio %}
    <div id="portalAudio" style="display: none;">
        {% for audio_type, audio_data in portal_audio.items %}
        <audio id="audio_{{ audio_type }}" preload="auto" {% if audio_data.loop %}loop{% endif %}>
            <source src="{{ audio_data.url }}" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Use offline Bootstrap JS (includes all modal functionality) -->
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <!-- Insert Coin Modal -->
    <div class="modal fade" id="insertCoinModal" tabindex="-1" aria-labelledby="insertCoinModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="insertCoinModalLabel">
                        <i class="fas fa-coins me-2"></i>INSERT COIN
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="coin-animation mb-4">
                        <i class="fas fa-coins" style="font-size: 4rem; color: #ffc107; animation: bounce 1s infinite;"></i>
                    </div>
                    
                    <h4 class="mb-3">Waiting for coin insertion...</h4>
                    <p class="text-muted mb-4">Insert coins to accumulate credit. The system will automatically calculate your available time.</p>
                    
                    <div class="coin-status-info bg-light p-3 rounded mb-4">
                        <div class="row">
                            <div class="col-6">
                                <strong>Total Coins:</strong><br>
                                <span id="totalCoins" class="text-success">₱0.00</span>
                            </div>
                            <div class="col-6">
                                <strong>Available Time:</strong><br>
                                <span id="availableTime" class="text-primary">0 minutes</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Countdown Timer -->
                    <div class="countdown-container mb-4">
                        <div class="progress mb-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                                 role="progressbar" 
                                 id="countdownProgress" 
                                 style="width: 100%">
                            </div>
                        </div>
                        <h5>
                            Time remaining: <span id="countdownTimer" class="text-warning">60</span> seconds
                        </h5>
                    </div>
                    
                    <!-- Connect Button -->
                    <div id="coinStatus" class="text-center mb-3">
                        <button class="btn btn-success btn-lg" onclick="startSession()" id="connectBtn">
                            <i class="fas fa-play me-2"></i>CONNECT
                        </button>
                        <p class="text-muted mt-2 mb-0">Click CONNECT to start your internet session</p>
                    </div>
                    
                    <!-- Coin Detection Animation -->
                    <div id="coinDetected" class="alert alert-success d-none">
                        <i class="fas fa-check-circle me-2"></i>
                        Coin detected! Processing payment...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Voucher Redemption Modal -->
    <div class="modal fade" id="voucherModal" tabindex="-1" aria-labelledby="voucherModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="voucherModalLabel">
                        <i class="fas fa-ticket-alt me-2"></i>Use Voucher
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-ticket-alt" style="font-size: 3rem; color: #28a745;"></i>
                        <h4 class="mt-3 mb-3">Enter Your Voucher Code</h4>
                        <p class="text-muted">Enter the voucher code to add time to your account</p>
                    </div>
                    
                    <form id="voucherForm">
                        <div class="mb-3">
                            <label for="voucherCode" class="form-label">Voucher Code</label>
                            <input type="text" class="form-control form-control-lg text-center" id="voucherCode" 
                                   placeholder="Enter voucher code" maxlength="20" style="letter-spacing: 2px; font-family: monospace; text-transform: uppercase;"
                                   oninput="this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '')">
                            <div class="form-text">Enter the code exactly as shown on your voucher</div>
                        </div>
                        
                        <div id="voucherStatus" class="mb-3"></div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg" id="redeemBtn">
                                <i class="fas fa-check me-2"></i>Redeem Voucher
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- WiFi Rates Modal -->
    <div class="modal fade" id="ratesModal" tabindex="-1" aria-labelledby="ratesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="ratesModalLabel">
                        <i class="fas fa-list me-2"></i>WiFi Rates
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="rates-list">
                        {% if rate_type == 'manual' %}
                            {% for rate in rates %}
                            <div class="rate-item d-flex justify-content-between align-items-center p-3 mb-2 bg-light rounded">
                                <div>
                                    <strong class="text-primary">₱{{ rate.Denom }}</strong>
                                    {% if rate.Pulse %}
                                    <small class="text-muted d-block">{{ rate.Pulse }} pulse(s)</small>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success fs-6">{{ rate.Minutes }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            {% for rate in rates %}
                            <div class="rate-item d-flex justify-content-between align-items-center p-3 mb-2 bg-light rounded">
                                <div>
                                    <strong class="text-primary">₱{{ rate.Denom }}</strong>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success fs-6">{{ rate.auto_rate|floatformat:0 }} minutes</span>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <div class="mt-4 p-3 bg-primary bg-opacity-10 rounded">
                        <h6 class="text-primary mb-2">
                            <i class="fas fa-info-circle me-2"></i>Rate Information
                        </h6>
                        <small class="text-muted">
                            {% if rate_type == 'manual' %}
                                Custom rates are configured by the administrator.
                            {% else %}
                                Automatic rates: {{ base_value }} per peso.
                            {% endif %}
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        
        .coin-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .progress-bar-animated {
            animation: progress-bar-stripes 1s linear infinite;
        }
        
        .countdown-container {
            border: 2px dashed #ffc107;
            padding: 20px;
            border-radius: 10px;
            background: rgba(255, 193, 7, 0.1);
        }
        
        .mac-address-info {
            transition: all 0.3s ease;
            user-select: all;
            letter-spacing: 1px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .mac-address-info:hover {
            background-color: #f8f9fa;
            color: #495057 !important;
            transform: scale(1.02);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }
    </style>

    <script>
        // Portal Audio System
        const PortalAudio = {
            audioElements: {},
            
            init: function() {
                // console.log('Initializing Portal Audio System...');
                
                // Initialize audio elements
                {% if portal_audio %}
                {% for audio_type, audio_data in portal_audio.items %}
                // console.log('Loading audio: {{ audio_type }} from {{ audio_data.url }}');
                this.audioElements['{{ audio_type }}'] = document.getElementById('audio_{{ audio_type }}');
                if (this.audioElements['{{ audio_type }}']) {
                    this.audioElements['{{ audio_type }}'].volume = {{ audio_data.volume|default:50 }} / 100;
                    // console.log('Audio element {{ audio_type }} loaded successfully with volume {{ audio_data.volume|default:50 }}%');
                } else {
                    console.error('Audio element audio_{{ audio_type }} not found in DOM');
                }
                {% endfor %}
                {% else %}
                // console.log('No portal audio data available');
                {% endif %}
                
                // Don't auto-play background music on page load
                // console.log('Audio system initialized - background music will play when INSERT COIN is clicked');
            },
            
            play: function(audioType) {
                try {
                    if (this.audioElements[audioType]) {
                        // Reset audio to beginning
                        this.audioElements[audioType].currentTime = 0;
                        
                        // Play audio with user interaction handling
                        const playPromise = this.audioElements[audioType].play();
                        if (playPromise !== undefined) {
                            playPromise.catch(error => {
                                // console.log('Audio play failed (user interaction required):', error);
                            });
                        }
                    }
                } catch (error) {
                    // console.log('Error playing audio:', error);
                }
            },
            
            stop: function(audioType) {
                try {
                    if (this.audioElements[audioType]) {
                        this.audioElements[audioType].pause();
                        this.audioElements[audioType].currentTime = 0;
                    }
                } catch (error) {
                    // console.log('Error stopping audio:', error);
                }
            },
            
            playBackground: function() {
                // Auto-play background music if available
                if (this.audioElements['background']) {
                    // Reset to beginning and try to play
                    this.audioElements['background'].currentTime = 0;
                    
                    const playPromise = this.audioElements['background'].play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            // console.log('Background music started successfully');
                        }).catch(error => {
                            // Auto-play was blocked - common in modern browsers
                            // console.log('Auto-play blocked by browser policy, waiting for user interaction:', error.name);
                            
                            // Only set up interaction listeners if not already playing
                            if (this.audioElements['background'].paused) {
                                this.setupAutoPlayOnInteraction();
                            }
                        });
                    }
                } else {
                    // console.log('No background audio element found');
                }
            },
            
            setupAutoPlayOnInteraction: function() {
                // Set up one-time listener for user interaction to start background music
                const startBackground = () => {
                    if (this.audioElements['background']) {
                        this.play('background');
                        // console.log('Background music started after user interaction');
                    }
                    // Remove listeners after first interaction
                    document.removeEventListener('click', startBackground);
                    document.removeEventListener('touchstart', startBackground);
                    document.removeEventListener('keydown', startBackground);
                };
                
                document.addEventListener('click', startBackground, { once: true });
                document.addEventListener('touchstart', startBackground, { once: true });
                document.addEventListener('keydown', startBackground, { once: true });
            }
        };
        
        // Initialize audio system when page loads (but don't auto-play music)
        document.addEventListener('DOMContentLoaded', function() {
            PortalAudio.init();
            
            // Compress IP address display
            compressIPDisplay();
        });
        
        // Function to compress IP address display
        function compressIPDisplay() {
            const ipElement = document.getElementById('compressedIP');
            if (ipElement) {
                const fullIP = ipElement.textContent;
                const compressedIP = getCompressedIP(fullIP);
                
                if (compressedIP !== fullIP) {
                    ipElement.textContent = compressedIP;
                    ipElement.title = `Full IP: ${fullIP}`;
                }
            }
        }
        
        // Function to get compressed IP
        function getCompressedIP(ip) {
            if (!ip || ip === 'Unknown') return ip;
            
            // For common local network patterns, show compressed version
            if (ip.startsWith('192.168.')) {
                // 192.168.1.100 -> ...1.100
                const parts = ip.split('.');
                return `...${parts[2]}.${parts[3]}`;
            } else if (ip.startsWith('10.')) {
                // 10.0.1.100 -> ...1.100
                const parts = ip.split('.');
                return `...${parts[2]}.${parts[3]}`;
            } else if (ip.startsWith('172.')) {
                // 172.16.1.100 -> ...1.100
                const parts = ip.split('.');
                return `...${parts[2]}.${parts[3]}`;
            } else if (ip === '127.0.0.1') {
                // Localhost -> Local
                return 'Local';
            }
            
            // For other IPs, keep full display
            return ip;
        }
        
        // Banner Carousel Functionality
        let currentSlide = 0;
        const slides = document.querySelectorAll('.carousel-slide');
        const indicators = document.querySelectorAll('.indicator');
        const totalSlides = slides.length;

        function showSlide(index) {
            // Only proceed if we have slides
            if (totalSlides === 0) return;
            
            // Hide all slides
            slides.forEach(slide => {
                slide.style.opacity = '0';
                slide.classList.remove('active');
            });
            
            // Hide all indicators (only if they exist)
            indicators.forEach(indicator => {
                indicator.style.background = 'rgba(255,255,255,0.4)';
                indicator.classList.remove('active');
            });
            
            // Show current slide
            slides[index].style.opacity = '1';
            slides[index].classList.add('active');
            
            // Update indicator if it exists
            if (indicators[index]) {
                indicators[index].style.background = 'rgba(255,255,255,0.8)';
                indicators[index].classList.add('active');
            }
        }

        function nextSlide() {
            currentSlide = (currentSlide + 1) % totalSlides;
            showSlide(currentSlide);
        }

        // Only start auto-advance if there are multiple slides
        if (totalSlides > 1) {
            setInterval(nextSlide, 5000);
        }

        // Add click handlers to indicators (only if they exist)
        indicators.forEach((indicator, index) => {
            indicator.addEventListener('click', () => {
                currentSlide = index;
                showSlide(currentSlide);
            });
        });

        let countdownTimer = null;
        let timeLeft = {{ slot_timeout|default:60 }}; // Portal-controlled countdown
        let coinCheckInterval = null;

        function insertCoin() {
            // Start background music when INSERT COIN is clicked
            PortalAudio.playBackground();
            // console.log('Background music started - INSERT COIN clicked');
            
            // First check if coin slot is available and claim it
            fetch('/app/slot?claim=true', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (!data.Slot_Available) {
                    // Coin slot is busy, show message
                    alert('Coin slot is currently busy. Another client is inserting coins. Please try again in a few moments.');
                    return;
                }
                
                // Initialize coin tracking
                document.getElementById('totalCoins').textContent = '₱' + (data.Total_Coins || 0).toFixed(2);
                const availableMinutes = data.Available_Time || 0;
                document.getElementById('availableTime').textContent = formatTimeMinutes(availableMinutes);
                
                // Reset countdown to full time - portal is the authority
                timeLeft = {{ slot_timeout|default:60 }};
                document.getElementById('countdownTimer').textContent = timeLeft;
                document.getElementById('countdownProgress').style.width = '100%';
                
                // Set initial status based on existing coins
                if (data.Total_Coins > 0) {
                    document.getElementById('coinStatus').innerHTML = `
                        <div class="text-center">
                            <button class="btn btn-success btn-lg" onclick="startSession()" id="connectBtn">
                                <i class="fas fa-play me-2"></i>CONNECT
                            </button>
                            <p class="text-success mt-2 mb-0">
                                <i class="fas fa-check-circle me-1"></i>
                                Coins detected! Click CONNECT to start your session.
                            </p>
                        </div>
                    `;
                } else {
                    document.getElementById('coinStatus').innerHTML = `
                        <div class="text-center">
                            <button class="btn btn-success btn-lg" onclick="startSession()" id="connectBtn">
                                <i class="fas fa-play me-2"></i>CONNECT
                            </button>
                            <p class="text-muted mt-2 mb-0">Click CONNECT to start your internet session</p>
                        </div>
                    `;
                }
                document.getElementById('coinDetected').classList.add('d-none');
                
                // Show modal using Bootstrap 5 API
                const modal = new bootstrap.Modal(document.getElementById('insertCoinModal'));
                modal.show();
                
                // Start countdown
                startCountdown();
                
                // Immediately update database with initial countdown state
                setTimeout(() => {
                    // console.log('Initial database update with timeLeft:', timeLeft);
                    updateSlotDatabase();
                }, 1000);
                
                // Start checking for coins
                startCoinDetection();
            })
            .catch(error => {
                console.error('Error checking coin slot:', error);
                alert('Error accessing coin slot. Please try again.');
            });
        }

        function startCountdown() {
            countdownTimer = setInterval(function() {
                timeLeft--;
                document.getElementById('countdownTimer').textContent = timeLeft;
                
                // Update progress bar
                const progressPercent = (timeLeft / {{ slot_timeout|default:60 }}) * 100;
                document.getElementById('countdownProgress').style.width = progressPercent + '%';
                
                // Change progress bar color as time runs out
                const progressBar = document.getElementById('countdownProgress');
                if (timeLeft <= 20) {
                    progressBar.classList.remove('bg-warning');
                    progressBar.classList.add('bg-danger');
                } else if (timeLeft <= 40) {
                    progressBar.classList.remove('bg-warning');
                    progressBar.classList.add('bg-warning');
                }
                
                // Update database every 10 seconds with portal countdown
                if (timeLeft % 10 === 0 || timeLeft === {{ slot_timeout|default:60 }} - 1) {
                    // console.log('Updating database with timeLeft:', timeLeft);
                    updateSlotDatabase();
                }
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    clearInterval(coinCheckInterval);
                    
                    // Notify database that countdown expired
                    updateSlotDatabase('expired');
                    
                    // Show timeout message
                    document.getElementById('coinStatus').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Time expired! Please insert more coins or try again.
                        </div>
                    `;
                    
                    // Auto close modal after 3 seconds
                    setTimeout(function() {
                        bootstrap.Modal.getInstance(document.getElementById('insertCoinModal')).hide();
                    }, 3000);
                }
            }, 1000);
        }

        function updateSlotDatabase(action = 'update') {
            // Update database with portal countdown status
            // console.log('updateSlotDatabase called with action:', action, 'timeLeft:', timeLeft);
            
            fetch('/app/slot/update', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    remaining_seconds: timeLeft,
                    action: action
                })
            })
            .then(response => response.json())
            .then(data => {
                // console.log('Database update response:', data);
            })
            .catch(error => {
                // console.log('Error updating slot database:', error);
            });
        }

        function startCoinDetection() {
            // Check for coin insertion every 2 seconds
            coinCheckInterval = setInterval(function() {
                checkCoinStatus();
            }, 2000);
        }

        function checkCoinStatus() {
            // Track current coin amount for sound detection
            const currentCoins = parseFloat(document.getElementById('totalCoins').textContent.replace('₱', '')) || 0;
            
            // Make AJAX request to check if coin was inserted
            fetch('/app/slot', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                // Check if slot is still available
                if (!data.Slot_Available && data.Slot_Status === 'busy') {
                    // Another client took over the slot
                    clearInterval(countdownTimer);
                    clearInterval(coinCheckInterval);
                    
                    document.getElementById('coinStatus').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Another client is using the coin slot. Session ended.
                        </div>
                    `;
                    
                    // Auto close modal after 3 seconds
                    setTimeout(function() {
                        bootstrap.Modal.getInstance(document.getElementById('insertCoinModal')).hide();
                    }, 3000);
                    return;
                }
                
                // Portal is the timer authority - no sync needed
                
                // Update coin display and check for new coins
                if (data.Total_Coins && data.Total_Coins > 0) {
                    const newCoinAmount = data.Total_Coins;
                    
                    // Play coin sound only if coin amount increased (actual pulse detected)
                    if (newCoinAmount > currentCoins) {
                        // console.log('Coin pulse detected! Playing coin sound...');
                        PortalAudio.play('coin_accepted');
                    }
                    
                    document.getElementById('totalCoins').textContent = '₱' + newCoinAmount.toFixed(2);
                    document.getElementById('availableTime').textContent = formatTimeMinutes(data.Available_Time);
                }
                
                if (data.Total_Coins > 0) {
                    // Enable connect button when coins are available
                    document.getElementById('coinStatus').innerHTML = `
                        <div class="text-center">
                            <button class="btn btn-success btn-lg" onclick="startSession()" id="connectBtn">
                                <i class="fas fa-play me-2"></i>CONNECT
                            </button>
                            <p class="text-success mt-2 mb-0">
                                <i class="fas fa-check-circle me-1"></i>
                                Coins detected! Click CONNECT to start your session.
                            </p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                // console.log('Coin check error:', error);
            });
        }

        function formatTimeMinutes(minutes) {
            if (minutes >= 60) {
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                return hours + 'h ' + remainingMinutes + 'm';
            }
            return Math.floor(minutes) + ' minutes';
        }

        function coinDetected() {
            // Stop timers
            clearInterval(countdownTimer);
            clearInterval(coinCheckInterval);
            
            // Show success message
            document.getElementById('coinStatus').classList.add('d-none');
            document.getElementById('coinDetected').classList.remove('d-none');
            
            // Update progress bar to success
            const progressBar = document.getElementById('countdownProgress');
            progressBar.style.width = '100%';
            progressBar.classList.remove('bg-warning', 'bg-danger');
            progressBar.classList.add('bg-success');
            
            // Auto close modal and refresh portal after 2 seconds
            setTimeout(function() {
                bootstrap.Modal.getInstance(document.getElementById('insertCoinModal')).hide();
                location.reload(); // Refresh to show updated status
            }, 2000);
        }

        function refreshCoinStatus() {
            checkCoinStatus();
        }

        function startSession() {
            // Disable connect button and show loading
            const connectBtn = document.getElementById('connectBtn');
            connectBtn.disabled = true;
            connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>CONNECTING...';
            
            // Make AJAX request to start browsing session
            const params = new URLSearchParams({
                ip: '{{ ip }}',
                mac: '{{ mac }}'
            });
            
            fetch(`/app/browse?${params}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status_code === 200) {
                    // Stop background music on successful connection
                    PortalAudio.stop('background');
                    // console.log('Background music stopped - client connected successfully');
                    
                    // Play connection success sound
                    PortalAudio.play('connection_success');
                    
                    // Session started successfully
                    document.getElementById('coinStatus').innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Session started successfully! You are now connected.
                        </div>
                    `;
                    
                    // Close modal and refresh portal after 2 seconds
                    setTimeout(function() {
                        bootstrap.Modal.getInstance(document.getElementById('insertCoinModal')).hide();
                        location.reload();
                    }, 2000);
                } else {
                    // Play connection failed sound
                    PortalAudio.play('connection_failed');
                    
                    // Session failed
                    document.getElementById('coinStatus').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${data.description || 'Failed to start session. Please try again.'}
                        </div>
                        <button class="btn btn-success btn-lg mt-2" onclick="startSession()" id="connectBtn">
                            <i class="fas fa-play me-2"></i>CONNECT
                        </button>
                    `;
                }
            })
            .catch(error => {
                // console.log('Session start error:', error);
                document.getElementById('coinStatus').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Connection error. Please try again.
                    </div>
                    <button class="btn btn-success btn-lg mt-2" onclick="startSession()" id="connectBtn">
                        <i class="fas fa-play me-2"></i>CONNECT
                    </button>
                `;
            });
        }
        
        function useVoucher() {
            // Show voucher modal using Bootstrap 5 API
            const modal = new bootstrap.Modal(document.getElementById('voucherModal'));
            modal.show();
        }
        
        function showRates() {
            // Show rates modal using Bootstrap 5 API
            const modal = new bootstrap.Modal(document.getElementById('ratesModal'));
            modal.show();
        }
        
        // Voucher redemption functionality
        document.getElementById('voucherForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const voucherCode = document.getElementById('voucherCode').value.trim().toUpperCase();
            const redeemBtn = document.getElementById('redeemBtn');
            const voucherStatus = document.getElementById('voucherStatus');
            
            if (!voucherCode) {
                voucherStatus.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Please enter a voucher code
                    </div>
                `;
                return;
            }
            
            // Disable button and show loading
            redeemBtn.disabled = true;
            redeemBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Redeeming...';
            
            // Create FormData for the request
            const formData = new FormData();
            formData.append('voucher', voucherCode);
            formData.append('mac', '{{ mac }}');
            
            // Make AJAX request to redeem voucher
            fetch('/app/redeem', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // Success - stop background music since client will be connected
                    PortalAudio.stop('background');
                    // console.log('Background music stopped - voucher redeemed successfully');
                    
                    voucherStatus.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            ${data.description || 'Voucher redeemed successfully!'}
                        </div>
                    `;
                    
                    // Close modal and refresh page after 2 seconds
                    setTimeout(function() {
                        bootstrap.Modal.getInstance(document.getElementById('voucherModal')).hide();
                        location.reload();
                    }, 2000);
                } else {
                    // Error
                    voucherStatus.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${data.description || 'Invalid or expired voucher code'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Voucher redemption error:', error);
                voucherStatus.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Network error. Please try again.
                    </div>
                `;
            })
            .finally(() => {
                // Re-enable button
                redeemBtn.disabled = false;
                redeemBtn.innerHTML = '<i class="fas fa-check me-2"></i>Redeem Voucher';
            });
        });
        
        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        function pauseSession() {
            // Stop background music since we're managing an active session
            PortalAudio.stop('background');
            // console.log('Background music stopped - session paused');
            
            // Make AJAX request to pause the session
            const params = new URLSearchParams({
                ip: '{{ ip }}',
                mac: '{{ mac }}',
                action: 'pause'
            });
            
            fetch(`/app/pause?${params}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => {
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                location.reload();
            });
        }
        
        function resumeSession() {
            // Stop background music since we're resuming an active session
            PortalAudio.stop('background');
            // console.log('Background music stopped - session resumed');
            
            // Make AJAX request to resume the session
            const params = new URLSearchParams({
                ip: '{{ ip }}',
                mac: '{{ mac }}',
                action: 'resume'
            });
            
            fetch(`/app/pause?${params}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => {
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                location.reload();
            });
        }

        function releaseCoinSlot() {
            // Update database that portal closed/expired
            updateSlotDatabase('expired');
        }

        // Clean up intervals when coin modal is closed
        document.getElementById('insertCoinModal').addEventListener('hidden.bs.modal', function () {
            if (countdownTimer) clearInterval(countdownTimer);
            if (coinCheckInterval) clearInterval(coinCheckInterval);
            
            // Stop background music when modal is closed
            PortalAudio.stop('background');
            // console.log('Background music stopped - coin modal closed');
            
            // Notify database that portal was manually closed
            releaseCoinSlot();
        });
        
        // Stop background music when voucher modal is closed
        document.getElementById('voucherModal').addEventListener('hidden.bs.modal', function () {
            // Stop background music when voucher modal is closed
            PortalAudio.stop('background');
            // console.log('Background music stopped - voucher modal closed');
        });

        // Load existing credits on page load
        function loadExistingCredits() {
            const mac = '{{ mac }}';
            
            // Check if creditSection exists (not available in blocked state)
            const creditSection = document.getElementById('creditSection');
            if (!creditSection) {
                // console.log('Credit section not available (blocked state or other)');
                return;
            }
            
            // Skip if MAC is null or default
            if (!mac || mac === '00:00:00:00:00:00') {
                // console.log('Invalid MAC address, skipping credit check');
                creditSection.style.display = 'none';
                return;
            }
            
            fetch('/app/commit?mac=' + mac, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                // console.log('Credit data received:', data);
                
                if (data.Error) {
                    // console.log('Server error:', data.Error);
                }
                
                if (data.Total_Coins && data.Total_Coins > 0) {
                    // Show credit section
                    creditSection.style.display = 'block';
                    
                    // Update credit display
                    const creditAmount = document.getElementById('creditAmount');
                    const creditTime = document.getElementById('creditTime');
                    
                    if (creditAmount) creditAmount.textContent = '₱' + data.Total_Coins.toFixed(2);
                    if (creditTime) {
                        const minutes = Math.floor(data.Total_Time / 60);
                        creditTime.textContent = minutes + ' min';
                    }
                    
                    // console.log('Credits loaded: ₱' + data.Total_Coins + ', ' + Math.floor(data.Total_Time / 60) + ' minutes');
                } else {
                    // Hide credit section if no credits  
                    creditSection.style.display = 'none';
                    // console.log('No credits found for this client');
                }
            })
            .catch(error => {
                // console.log('Error loading credits:', error);
                creditSection.style.display = 'none';
            });
        }

        // Load credits when page loads
        window.addEventListener('load', loadExistingCredits);

        // Copy MAC address to clipboard
        function copyMacAddress() {
            const macElement = document.getElementById('macAddress');
            const macText = macElement.textContent || macElement.innerText;
            
            // Try modern clipboard API first
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(macText).then(function() {
                    showCopyFeedback('MAC address copied to clipboard!');
                }).catch(function(err) {
                    // console.log('Clipboard copy failed:', err);
                    fallbackCopyTextToClipboard(macText);
                });
            } else {
                // Fallback for older browsers
                fallbackCopyTextToClipboard(macText);
            }
        }

        // Fallback copy method for older browsers
        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopyFeedback('MAC address copied to clipboard!');
                } else {
                    showCopyFeedback('Copy failed. Please select and copy manually.', 'error');
                }
            } catch (err) {
                // console.log('Fallback copy failed:', err);
                showCopyFeedback('Copy not supported. Please select and copy manually.', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        // Show copy feedback
        function showCopyFeedback(message, type = 'success') {
            const macInfo = document.querySelector('.mac-address-info');
            
            // Change background color temporarily
            if (type === 'success') {
                macInfo.style.backgroundColor = '#d4edda';
                macInfo.style.color = '#155724';
            } else {
                macInfo.style.backgroundColor = '#f8d7da';
                macInfo.style.color = '#721c24';
            }
            
            // Show message in console and as a brief visual feedback
            // console.log(message);
            
            // Reset after 1.5 seconds
            setTimeout(function() {
                macInfo.style.backgroundColor = '';
                macInfo.style.color = '#6c757d';
            }, 1500);
        }

        // Copy expiry date function
        function copyExpiryDate() {
            const expiryElement = document.getElementById('expiryDate');
            const expiryText = expiryElement.textContent || expiryElement.innerText;
            
            // Try modern clipboard API first
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(expiryText).then(function() {
                    showExpiryFeedback('Expiry date copied to clipboard!');
                }).catch(function(err) {
                    // console.log('Clipboard copy failed:', err);
                    fallbackCopyExpiryToClipboard(expiryText);
                });
            } else {
                fallbackCopyExpiryToClipboard(expiryText);
            }
        }

        // Fallback copy method for expiry date
        function fallbackCopyExpiryToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showExpiryFeedback('Expiry date copied to clipboard!');
                } else {
                    showExpiryFeedback('Copy failed. Please select and copy manually.', 'error');
                }
            } catch (err) {
                // console.log('Fallback copy failed:', err);
                showExpiryFeedback('Copy not supported. Please select and copy manually.', 'error');
            }
            
            document.body.removeChild(textArea);
        }

        // Show copy feedback for expiry
        function showExpiryFeedback(message, type = 'success') {
            const expiryInfo = document.getElementById('expiryDate');
            
            // Store original color
            const originalColor = expiryInfo.style.color;
            
            // Change background color temporarily
            if (type === 'success') {
                expiryInfo.style.backgroundColor = '#d4edda';
                expiryInfo.style.color = '#155724';
            } else {
                expiryInfo.style.backgroundColor = '#f8d7da';
                expiryInfo.style.color = '#721c24';
            }
            
            // Show message in console
            // console.log(message);
            
            // Reset after 1.5 seconds
            setTimeout(function() {
                expiryInfo.style.backgroundColor = '';
                expiryInfo.style.color = originalColor;
            }, 1500);
        }

        // Auto refresh to update status (only if modal is not open)
        setInterval(function() {
            if (!document.getElementById('insertCoinModal').classList.contains('show')) {
                location.reload();
            }
        }, {{ auto_refresh_interval|default:30 }}000);
        
        // Autopause functionality (if enabled in settings)
        {% if pause_resume_flg == 1 %}
        let isOnline = navigator.onLine;
        let lastOnlineStatus = isOnline;
        let autoPauseProcessing = false;
        
        // Monitor connectivity status
        function checkConnectivityAndAutoPause() {
            const currentOnlineStatus = navigator.onLine;
            
            // Only process if status changed and not already processing
            if (currentOnlineStatus !== lastOnlineStatus && !autoPauseProcessing) {
                autoPauseProcessing = true;
                
                if (!currentOnlineStatus && '{{ status }}' === 'Connected') {
                    // Client went offline while connected - auto pause
                    // console.log('Client went offline - auto pausing...');
                    autoPauseSession();
                } else if (currentOnlineStatus && '{{ status }}' === 'Paused') {
                    // Client came back online while paused - auto resume
                    // console.log('Client came back online - auto resuming...');
                    autoResumeSession();
                }
                
                lastOnlineStatus = currentOnlineStatus;
                
                // Reset processing flag after 2 seconds
                setTimeout(() => {
                    autoPauseProcessing = false;
                }, 2000);
            }
        }
        
        // Auto pause when offline
        function autoPauseSession() {
            const params = new URLSearchParams({
                ip: '{{ ip }}',
                mac: '{{ mac }}',
                action: 'pause'
            });
            
            fetch(`/app/pause?${params}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status_code === 200) {
                    // console.log('Session auto-paused due to connectivity loss');
                    // Don't reload immediately, wait for connection to restore
                }
            })
            .catch(error => {
                console.error('Auto-pause error:', error);
            });
        }
        
        // Auto resume when back online
        function autoResumeSession() {
            const params = new URLSearchParams({
                ip: '{{ ip }}',
                mac: '{{ mac }}',
                action: 'resume'
            });
            
            fetch(`/app/pause?${params}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status_code === 200) {
                    // console.log('Session auto-resumed after connectivity restored');
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Auto-resume error:', error);
            });
        }
        
        // Listen for online/offline events
        window.addEventListener('online', checkConnectivityAndAutoPause);
        window.addEventListener('offline', checkConnectivityAndAutoPause);
        
        // Also check periodically in case events don't fire
        setInterval(checkConnectivityAndAutoPause, 5000);
        {% endif %}
        
        // Activity tracking for inactive timeout
        let lastActivityTime = Date.now();
        let inactiveTimeoutMinutes = {{ inactive_timeout|default:30 }};
        let activityCheckInterval;
        
        // Track user activity
        function updateActivity() {
            lastActivityTime = Date.now();
        }
        
        // Check for inactivity and warn user
        function checkInactivity() {
            const now = Date.now();
            const inactiveTime = (now - lastActivityTime) / 1000 / 60; // minutes
            const warningTime = Math.max(5, inactiveTimeoutMinutes - 5); // 5 minutes before timeout
            
            if (inactiveTime >= warningTime && inactiveTime < inactiveTimeoutMinutes) {
                // Show warning
                const remainingMinutes = Math.ceil(inactiveTimeoutMinutes - inactiveTime);
                if (!document.getElementById('inactivityWarning')) {
                    showInactivityWarning(remainingMinutes);
                }
            } else if (inactiveTime >= inactiveTimeoutMinutes && '{{ status }}' !== 'Disconnected') {
                // Force disconnect after timeout
                // console.log('Client inactive for too long, forcing disconnect...');
                forceDisconnectDueToInactivity();
            }
        }
        
        // Show inactivity warning
        function showInactivityWarning(remainingMinutes) {
            const warningDiv = document.createElement('div');
            warningDiv.id = 'inactivityWarning';
            warningDiv.className = 'alert alert-warning';
            warningDiv.style.position = 'fixed';
            warningDiv.style.top = '10px';
            warningDiv.style.left = '50%';
            warningDiv.style.transform = 'translateX(-50%)';
            warningDiv.style.zIndex = '9999';
            warningDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Inactivity Warning:</strong> You will be disconnected in ${remainingMinutes} minute(s) due to inactivity.
                <button onclick="dismissInactivityWarning()" class="btn btn-sm btn-outline-dark ms-2">Stay Connected</button>
            `;
            document.body.appendChild(warningDiv);
        }
        
        // Dismiss inactivity warning
        function dismissInactivityWarning() {
            const warning = document.getElementById('inactivityWarning');
            if (warning) {
                warning.remove();
                updateActivity(); // Reset activity timer
            }
        }
        
        // Force disconnect due to inactivity
        function forceDisconnectDueToInactivity() {
            const params = new URLSearchParams({
                ip: '{{ ip }}',
                mac: '{{ mac }}',
                action: 'pause'
            });
            
            fetch(`/app/pause?${params}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                alert('You have been disconnected due to inactivity.');
                location.reload();
            })
            .catch(error => {
                console.error('Force disconnect error:', error);
                location.reload();
            });
        }
        
        // Add activity listeners
        ['click', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, updateActivity, { passive: true });
        });
        
        // Start inactivity checking (only for non-whitelisted clients)
        {% if not whitelisted %}
        activityCheckInterval = setInterval(checkInactivity, 60000); // Check every minute
        {% endif %}
        
        // Format and update time display as xxD. xxHR. xxMIN. xxSEC.
        function formatTime(seconds) {
            if (seconds <= 0) return `0<span style="font-size: 0.6em; font-weight: normal;">HR.</span> 0<span style="font-size: 0.6em; font-weight: normal;">MIN.</span> 0<span style="font-size: 0.6em; font-weight: normal;">SEC.</span>`;
            
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            let timeString = "";
            if (days > 0) {
                timeString += `${days}<span style="font-size: 0.6em; font-weight: normal;">D.</span> `;
            }
            timeString += `${hours}<span style="font-size: 0.6em; font-weight: normal;">HR.</span> ${minutes}<span style="font-size: 0.6em; font-weight: normal;">MIN.</span> ${secs}<span style="font-size: 0.6em; font-weight: normal;">SEC.</span>`;
            
            return timeString;
        }
        
        // Update time display on page load
        window.addEventListener('DOMContentLoaded', function() {
            const timeLeftElement = document.getElementById('timeLeft');
            if (timeLeftElement) {
                const seconds = parseInt(timeLeftElement.dataset.seconds);
                timeLeftElement.innerHTML = formatTime(seconds);
                
                // If connected, update time every second
                {% if status == 'Connected' %}
                let remainingSeconds = seconds;
                const updateInterval = setInterval(function() {
                    remainingSeconds--;
                    if (remainingSeconds >= 0) {
                        timeLeftElement.innerHTML = formatTime(remainingSeconds);
                    } else {
                        clearInterval(updateInterval);
                        timeLeftElement.innerHTML = '<span style="color: #6c757d;">0<span style="font-size: 0.6em; font-weight: normal;">HR.</span> 0<span style="font-size: 0.6em; font-weight: normal;">MIN.</span> 0<span style="font-size: 0.6em; font-weight: normal;">SEC.</span></span>';
                        // Auto refresh to get updated status
                        setTimeout(() => location.reload(), 2000);
                    }
                }, 1000);
                {% endif %}
            }
        });
    </script>
</body>
</html>