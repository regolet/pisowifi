{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}System Information - {{ block.super }}{% endblock %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'admin/css/dashboard.css' %}">
<style>
.system-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.system-card {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.system-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.system-card h3 {
    margin: 0 0 15px 0;
    color: #333;
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.system-card .icon {
    font-size: 20px;
    width: 24px;
    text-align: center;
}

.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.metric-row:last-child {
    border-bottom: none;
}

.metric-label {
    font-weight: 500;
    color: #666;
}

.metric-value {
    font-weight: 600;
    color: #333;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background-color: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
    margin: 5px 0;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    border-radius: 10px;
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    font-weight: 600;
}

.progress-fill.warning {
    background: linear-gradient(90deg, #FF9800, #FFC107);
}

.progress-fill.danger {
    background: linear-gradient(90deg, #F44336, #FF5722);
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-success { background: #E8F5E8; color: #2E7D32; }
.status-warning { background: #FFF8E1; color: #F57C00; }
.status-danger { background: #FFEBEE; color: #C62828; }
.status-info { background: #E3F2FD; color: #1976D2; }
.status-secondary { background: #F5F5F5; color: #666; }

.temperature-display {
    font-size: 24px;
    font-weight: bold;
    text-align: center;
    margin: 10px 0;
}

.uptime-display {
    text-align: center;
    font-size: 18px;
    font-weight: 600;
    margin: 10px 0;
}

.network-list {
    max-height: 200px;
    overflow-y: auto;
}

.network-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.auto-refresh {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #007cba;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}

.auto-refresh:hover {
    background: #005a87;
    transform: translateY(-2px);
}

.auto-refresh.active {
    background: #28a745;
}

.last-updated {
    text-align: center;
    color: #666;
    font-size: 12px;
    margin-top: 10px;
    font-style: italic;
}

.detailed-info {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px;
    margin-top: 10px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
}

.system-overview {
    grid-column: 1 / -1;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: center;
    padding: 30px 20px;
}

.system-overview h2 {
    margin: 0 0 10px 0;
    font-size: 24px;
    font-weight: 300;
}

.system-overview .system-details {
    opacity: 0.9;
    font-size: 14px;
}

@media (max-width: 768px) {
    .system-info-grid {
        grid-template-columns: 1fr;
    }
    
    .auto-refresh {
        position: relative;
        bottom: auto;
        right: auto;
        margin: 20px auto;
        display: block;
    }
}
</style>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<meta name="viewport" content="width=device-width, initial-scale=1">
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a>
    &rsaquo; System Information
</div>
{% endblock %}

{% block content %}
<h1>System Information Dashboard</h1>

<div class="system-info-grid" id="systemInfoGrid">
    <!-- System Overview -->
    <div class="system-card system-overview">
        <h2 id="hostname">{{ system_info.system.node_name }}</h2>
        <div class="system-details">
            <div>{{ system_info.system.system }} {{ system_info.system.release }}</div>
            <div>{{ system_info.system.architecture }} ‚Ä¢ Python {{ system_info.system.python_version }}</div>
        </div>
    </div>

    <!-- CPU Information -->
    <div class="system-card">
        <h3><span class="icon">üñ•Ô∏è</span> CPU Usage</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="cpuProgress" style="width: {{ system_info.cpu.usage }}%">
                <span id="cpuUsage">{{ system_info.cpu.usage }}%</span>
            </div>
        </div>
        <div class="metric-row">
            <span class="metric-label">Cores (Physical/Logical)</span>
            <span class="metric-value" id="cpuCores">{{ system_info.cpu.info.physical_cores }}/{{ system_info.cpu.info.total_cores }}</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">Frequency</span>
            <span class="metric-value" id="cpuFreq">{{ system_info.cpu.info.current_frequency|floatformat:0 }} MHz</span>
        </div>
    </div>

    <!-- Memory Information -->
    <div class="system-card">
        <h3><span class="icon">üß†</span> Memory Usage</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="memoryProgress" style="width: {{ system_info.memory.percent }}%">
                <span id="memoryUsage">{{ system_info.memory.percent }}%</span>
            </div>
        </div>
        <div class="metric-row">
            <span class="metric-label">Used / Total</span>
            <span class="metric-value" id="memoryStats">{{ system_info.memory.used_gb }} GB / {{ system_info.memory.total_gb }} GB</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">Available</span>
            <span class="metric-value" id="memoryAvailable">{{ system_info.memory.free_gb }} GB</span>
        </div>
    </div>

    <!-- Disk Usage -->
    <div class="system-card">
        <h3><span class="icon">üíΩ</span> Storage Usage</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="diskProgress" style="width: {{ system_info.disk.percent }}%">
                <span id="diskUsage">{{ system_info.disk.percent }}%</span>
            </div>
        </div>
        <div class="metric-row">
            <span class="metric-label">Used / Total</span>
            <span class="metric-value" id="diskStats">{{ system_info.disk.used_gb }} GB / {{ system_info.disk.total_gb }} GB</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">Free Space</span>
            <span class="metric-value" id="diskFree">{{ system_info.disk.free_gb }} GB</span>
        </div>
    </div>

    <!-- Temperature -->
    <div class="system-card">
        <h3><span class="icon">üå°Ô∏è</span> Temperature</h3>
        {% if system_info.temperature %}
        <div class="temperature-display" id="temperature">
            {{ system_info.temperature.current|floatformat:1 }}¬∞C
        </div>
        <div style="text-align: center; color: #666; font-size: 12px;">
            Sensor: <span id="tempSensor">{{ system_info.temperature.sensor }}</span>
        </div>
        {% else %}
        <div class="temperature-display" style="color: #999;">
            No sensor data
        </div>
        {% endif %}
    </div>

    <!-- System Uptime -->
    <div class="system-card">
        <h3><span class="icon">‚è∞</span> System Uptime</h3>
        <div class="uptime-display" id="uptime">
            {{ system_info.uptime.uptime_days }}d {{ system_info.uptime.uptime_hours }}h {{ system_info.uptime.uptime_minutes }}m
        </div>
        {% if system_info.uptime.boot_time %}
        <div style="text-align: center; color: #666; font-size: 12px;">
            Boot time: {{ system_info.uptime.boot_time|date:"M d, Y H:i" }}
        </div>
        {% endif %}
    </div>

    <!-- Load Average (Unix-like systems) -->
    {% if system_info.load_average %}
    <div class="system-card">
        <h3><span class="icon">üìä</span> Load Average</h3>
        <div class="metric-row">
            <span class="metric-label">1 minute</span>
            <span class="metric-value" id="load1">{{ system_info.load_average.load1 }}</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">5 minutes</span>
            <span class="metric-value" id="load5">{{ system_info.load_average.load5 }}</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">15 minutes</span>
            <span class="metric-value" id="load15">{{ system_info.load_average.load15 }}</span>
        </div>
    </div>
    {% endif %}

    <!-- Process Information -->
    <div class="system-card">
        <h3><span class="icon">‚öôÔ∏è</span> PISOWifi Process</h3>
        <div class="metric-row">
            <span class="metric-label">PID</span>
            <span class="metric-value" id="processPid">{{ system_info.process.pid }}</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">CPU Usage</span>
            <span class="metric-value" id="processCpu">{{ system_info.process.cpu_percent }}%</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">Memory Usage</span>
            <span class="metric-value" id="processMemory">{{ system_info.process.memory_percent|floatformat:1 }}%</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">Threads</span>
            <span class="metric-value" id="processThreads">{{ system_info.process.num_threads }}</span>
        </div>
    </div>

    <!-- Network Interfaces -->
    <div class="system-card">
        <h3><span class="icon">üåê</span> Network Interfaces</h3>
        <div class="network-list" id="networkList">
            {% for interface, info in system_info.network.items %}
            {% if info.is_up and info.ip_addresses %}
            <div class="network-item">
                <div>
                    <strong>{{ interface }}</strong><br>
                    <small>{{ info.ip_addresses.0 }}</small>
                </div>
                <div style="text-align: right; font-size: 12px;">
                    <div>‚Üë {{ info.bytes_sent|filesizeformat }}</div>
                    <div>‚Üì {{ info.bytes_recv|filesizeformat }}</div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Logged Users -->
    {% if system_info.users %}
    <div class="system-card">
        <h3><span class="icon">üë•</span> Logged Users</h3>
        {% for user in system_info.users %}
        <div class="metric-row">
            <span class="metric-label">{{ user.name }}</span>
            <span class="metric-value">{{ user.terminal }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<div class="last-updated" id="lastUpdated">
    Last updated: {{ system_info.timestamp|date:"M d, Y H:i:s" }}
</div>

<button class="auto-refresh" id="autoRefreshBtn" onclick="toggleAutoRefresh()">
    <span id="refreshText">Enable Auto Refresh</span>
</button>
{% endblock %}

{% block extrajs %}
{{ block.super }}
<script>
let autoRefreshInterval = null;
let isAutoRefresh = false;

function updateSystemInfo() {
    fetch('{% url "system_info:api" %}')
        .then(response => response.json())
        .then(data => {
            updateUI(data);
            document.getElementById('lastUpdated').textContent = 
                `Last updated: ${new Date().toLocaleString()}`;
        })
        .catch(error => {
            console.error('Error fetching system info:', error);
        });
}

function updateUI(data) {
    // Update CPU
    const cpuProgress = document.getElementById('cpuProgress');
    const cpuUsage = document.getElementById('cpuUsage');
    cpuProgress.style.width = data.cpu.usage + '%';
    cpuUsage.textContent = data.cpu.usage + '%';
    updateProgressColor(cpuProgress, data.cpu.usage);
    
    document.getElementById('cpuCores').textContent = 
        `${data.cpu.physical_cores}/${data.cpu.cores}`;
    document.getElementById('cpuFreq').textContent = 
        `${Math.round(data.cpu.frequency)} MHz`;

    // Update Memory
    const memoryProgress = document.getElementById('memoryProgress');
    const memoryUsage = document.getElementById('memoryUsage');
    memoryProgress.style.width = data.memory.used_percent + '%';
    memoryUsage.textContent = data.memory.used_percent + '%';
    updateProgressColor(memoryProgress, data.memory.used_percent);
    
    document.getElementById('memoryStats').textContent = 
        `${data.memory.used_gb} GB / ${data.memory.total_gb} GB`;
    document.getElementById('memoryAvailable').textContent = 
        `${data.memory.available_gb} GB`;

    // Update Disk
    const diskProgress = document.getElementById('diskProgress');
    const diskUsage = document.getElementById('diskUsage');
    diskProgress.style.width = data.disk.used_percent + '%';
    diskUsage.textContent = data.disk.used_percent + '%';
    updateProgressColor(diskProgress, data.disk.used_percent);
    
    document.getElementById('diskStats').textContent = 
        `${data.disk.used_gb} GB / ${data.disk.total_gb} GB`;
    document.getElementById('diskFree').textContent = 
        `${data.disk.free_gb} GB`;

    // Update Temperature
    if (data.temperature) {
        const tempElement = document.getElementById('temperature');
        const sensorElement = document.getElementById('tempSensor');
        if (tempElement) {
            tempElement.textContent = data.temperature.current.toFixed(1) + '¬∞C';
        }
        if (sensorElement) {
            sensorElement.textContent = data.temperature.sensor;
        }
    }

    // Update Uptime
    document.getElementById('uptime').textContent = 
        `${data.uptime.days}d ${data.uptime.hours}h ${data.uptime.minutes}m`;

    // Update Load Average (if available)
    if (data.load_average) {
        const load1 = document.getElementById('load1');
        const load5 = document.getElementById('load5');
        const load15 = document.getElementById('load15');
        if (load1) load1.textContent = data.load_average.load1;
        if (load5) load5.textContent = data.load_average.load5;
        if (load15) load15.textContent = data.load_average.load15;
    }

    // Update Process Info
    document.getElementById('processCpu').textContent = data.process.cpu_percent + '%';
    document.getElementById('processMemory').textContent = 
        data.process.memory_percent.toFixed(1) + '%';
    document.getElementById('processThreads').textContent = data.process.threads;
}

function updateProgressColor(element, percentage) {
    element.classList.remove('warning', 'danger');
    if (percentage >= 90) {
        element.classList.add('danger');
    } else if (percentage >= 70) {
        element.classList.add('warning');
    }
}

function toggleAutoRefresh() {
    const btn = document.getElementById('autoRefreshBtn');
    const text = document.getElementById('refreshText');
    
    if (isAutoRefresh) {
        // Stop auto refresh
        clearInterval(autoRefreshInterval);
        isAutoRefresh = false;
        btn.classList.remove('active');
        text.textContent = 'Enable Auto Refresh';
    } else {
        // Start auto refresh
        autoRefreshInterval = setInterval(updateSystemInfo, 5000); // Update every 5 seconds
        isAutoRefresh = true;
        btn.classList.add('active');
        text.textContent = 'Disable Auto Refresh';
    }
}

// Manual refresh on page click
document.addEventListener('click', function(e) {
    if (e.target.closest('.system-card') && !isAutoRefresh) {
        updateSystemInfo();
    }
});

// Initial load
document.addEventListener('DOMContentLoaded', function() {
    // Set initial progress bar colors
    updateProgressColor(document.getElementById('cpuProgress'), {{ system_info.cpu.usage }});
    updateProgressColor(document.getElementById('memoryProgress'), {{ system_info.memory.percent }});
    updateProgressColor(document.getElementById('diskProgress'), {{ system_info.disk.percent }});
});
</script>
{% endblock %}